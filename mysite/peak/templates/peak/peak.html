{% extends "users/base.html" %}
{% load leaflet_tags %}
{% load crispy_forms_tags %}

{% block content %}
<div class="content-fluid ">
  <div class="col-sm-2  tab-sidebar-content ">
    <nav id="#sidebar" class="nav-sidebar left-sidebar">
      <ul class="nav tabs">
          <li class=""><a class="active" href="#maptwod" data-toggle="tab">Map2d</a></li>
          <li class=""><a href="#mapthreed" data-toggle="tab">Map3d</a></li>                               
      </ul>
    </nav>
  </div>

    <div class="col-sm-10 tab-sidebar-content-right">
        <!-- tab content -->
        <div class="tab-content">
            <!-- PROFILE TAB-->
            <div class="tab-pane active text-style" id="maptwod">
                <div class="map">
                    {% if peak %}
                    {% leaflet_map "main" callback="map_init" %}  
                    {% else %}  
                    <h1>There are no peaks</h1>  
                    {% endif %}       
                </div>
            </div>

            <!-- Enrolled Campaigns -->
            <div class="tab-pane" id="mapthreed">
                <div class="media-body ">
                    <div id="cesiumContainer" style="width: 100%; height:400px"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="shadow-lg col-sm-6">     
                <div id="message-div"></div>
                <pre id="datahere"> <h1> Peak Information </h1></pre>
                <pre id="peak"></pre>
                {% if status.0.status != "Closed" and end_date.0.end_date|date:'Y-m-d' > actual_date %}
                    {% if user.is_authenticated and peak and user_enrolled %}
                        <div id="form-here">
                         {% if peak_of_user|length < 1  %}
                            <form action='' method='POST' id="submitAnnotation" >
                                {% csrf_token %}
                                {{ form|crispy }}
                                <input type="hidden" name="hidden_id" value="0" id="hidden_id">
                                <div class="form-group">
                                    <button class="btn btn-outline-info" type="submit">Add annotation</button>
                                </div>
                            </form>
                        {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                   {% if user.is_authenticated and peak and user_enrolled %}
                        <div id="form-here" class="form-here_hidden">
                         {% if peak_of_user|length < 1  %}
                            <form action='' method='POST' id="submitAnnotation" >
                                {% csrf_token %}
                                {{ form|crispy }}
                                <input type="hidden" name="hidden_id" value="0" id="hidden_id">
                                <div class="form-group">
                                    <button class="btn btn-outline-info" type="submit">Add annotation</button>
                                </div>
                            </form>
                        {% endif %}
                        </div>
                    {% endif %}

                {% endif %}
            </div>
            <div  class="shadow-lg col-sm-6">   
                <pre id="datahere"> <h1> Peak Annotations </h1></pre>
                <div id="annotation"></div>
            </div>
        </div>
    </div>
</div>

    <script type="text/javascript">  


        function map_init(map, options) {

            var LeafIcon = L.Icon.extend({
                options: {
                    iconSize:     [38, 50],
                    shadowSize:   [50, 64],
                    iconAnchor:   [22, 60],
                    shadowAnchor: [4, 62],
                    popupAnchor:  [-3, -76]
                }
            });
            map.locate({setView: true, maxZoom: 16});
            var marker          = L.marker(map.getCenter()).addTo(map),
            onLocationfound = function(e){
              marker.setLatLng(e.latlng);
              map.setView(marker.getLatLng(),map.getZoom()); 
            };

            map.on('locationfound', onLocationfound);

            var greenIcon = new LeafIcon({iconUrl: 'http://127.0.0.1:8000/media/pin1.png'}),
            redIcon = new LeafIcon({iconUrl: 'http://127.0.0.1:8000/media/pin2.png'}),
            orangeIcon = new LeafIcon({iconUrl: 'http://127.0.0.1:8000/media/pin3.png'});

            //creating a json format for the data we have so we can pass it to map

            var articles = [
                {% for p in evalated_peaks %}
                    {% if not forloop.first %},{% endif %}
                    {
                        lat     :    "{{ p.lat }}",
                        lon     :    "{{ p.lon }}",
                        status  :    "{{ p.status }}",
                        id      :    "{{ p.id     }}",
                    }
                {% endfor %}
                ]

             var not_evalated_peaks = [
                {% for p in not_evalated_peaks %}
                    {% if not forloop.first %},{% endif %}
                    {
                        lat     :    "{{ p.lat }}",
                        lon     :    "{{ p.lon }}",
                        status  :    "{{ p.status }}",
                        id      :    "{{ p.id     }}",
                    }
                {% endfor %}
                ]

                var not_to_annotate = [
                {% for p in not_to_annotate %}
                    {% if not forloop.first %},{% endif %}
                    {
                        lat     :    "{{ p.lat }}",
                        lon     :    "{{ p.lon }}",
                        status  :    "{{ p.status }}",
                        id      :    "{{ p.id     }}",
                    }
                {% endfor %}
                ]

            // setting a main point on the map where the map will be focused on oppening
            // map.setView([articles[0]['lat'], articles[1]['lon']], 12);

            //long lat variables
            var lat, lon;

            for (var i = 0; i < not_evalated_peaks.length; i++) {
                //console.log(articles[i]['lat']);
                lat  = not_evalated_peaks[i]['lat'];
                lon  = not_evalated_peaks[i]['lon'];
                id   = not_evalated_peaks[i]['id'];
                //console.log(articles[i]['status'].toLowerCase());
             
                L.marker([lat, lon], {icon: orangeIcon, title:'green', id:id}).addTo(map).on("click", groupClick);   
                
            }
            
            for (var i = 0; i < not_to_annotate.length; i++) {
                //console.log(articles[i]['lat']);
                lat  = not_to_annotate[i]['lat'];
                lon  = not_to_annotate[i]['lon'];
                id   = not_to_annotate[i]['id'];
                //console.log(articles[i]['status'].toLowerCase());
             
                L.marker([lat, lon], {icon: redIcon, title:'green', id:id}).addTo(map).on("click", groupClick);   
                
            }

            // the for loop to display the items on the map
            for (var i = 0; i < articles.length; i++) {
                //console.log(articles[i]['lat']);
                lat  = articles[i]['lat'];
                lon  = articles[i]['lon'];
                id   = articles[i]['id'];
                //console.log(articles[i]['status'].toLowerCase());
             
                L.marker([lat, lon], {icon: greenIcon, title:'green', id:id}).addTo(map).on("click", groupClick);   
                
            } //end for loop  

        }//end function map_init()

        

        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5YWZhNDVlMi0xNGE3LTRjM2UtOWRjOS1kMmI4MTE1NzQzMmQiLCJpZCI6MjEwNDMsInNjb3BlcyI6WyJhc2wiLCJhc3IiLCJhc3ciLCJnYyJdLCJpYXQiOjE1Nzg4MzY5Mzl9.pHkXKZcjJ6MKJsJ50Nv7jsCHgJwMqz0opqHv2RooEbI';
        var viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain()
        });

        var citizensBankPark = viewer.entities.add({
                  position : Cesium.Cartesian3.fromDegrees(-75.166493, 39.9060534),
                  billboard : {
                    image : 'http://127.0.0.1:8000/media/leaf-green.png',
                    width : 64,
                    height : 64
                  },
                  label : {
                    text : 'Citizens Bank Park',
                    font : '14pt monospace',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth : 2,
                    verticalOrigin : Cesium.VerticalOrigin.TOP,
                    pixelOffset : new Cesium.Cartesian2(0, 32)
                  }
                });

    </script>
{% endblock content %}